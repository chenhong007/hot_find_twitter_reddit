(function(){const w=c=>{if(!c)return 0;const e=c.trim().toUpperCase().replace(/,/g,"");if(e.includes("K"))return parseFloat(e.replace("K",""))*1e3;if(e.includes("M"))return parseFloat(e.replace("M",""))*1e6;if(e.includes("B"))return parseFloat(e.replace("B",""))*1e9;if(e.includes("万"))return parseFloat(e.replace("万",""))*1e4;if(e.includes("亿"))return parseFloat(e.replace("亿",""))*1e8;const r=parseFloat(e);return isNaN(r)?0:r},q=c=>{const e=new Date().toISOString();if(!c)return e;try{let r=c.trim();r.includes("月")&&!r.includes("年")&&(r=`${new Date().getFullYear()}年${r}`),r=r.replace(/年|月/g,"-").replace(/日/g,"");const n=new Date(r);if(!isNaN(n.getTime()))return n.toISOString()}catch{}return e},o={TWITTER:{ARTICLE:'article[data-testid="tweet"]',USER_NAME:'div[data-testid="User-Name"]',TWEET_TEXT:'div[data-testid="tweetText"]',METRIC_GROUP:'div[role="group"]',METRIC_TEST_ID_PREFIX:'[data-testid="',METRIC_TEXT_CONTAINER:'[data-testid="app-text-transition-container"]',ANALYTICS_LINK:'a[href*="/analytics"]'},SUBSTACK:{LINK_P:'a[href*="/p/"]',POST_PREVIEW_TITLE:"a.post-preview-title",READER_POST_CARD_TITLE:"a.reader-post-card-title",AUTHOR:[".pencraft.pc-reset.link-LIBpto",".post-preview-meta .profile-hover-card-target",".byline a",".post-header a.user-hover-card",".reader-post-card-byline a","a.reader-post-card-byline"],TIME:[".pencraft.pc-reset.color-secondary-ls1g8s","time"],CONTENT:[".reader-post-card-subtitle",".post-preview-description",".post-preview-content",".post-snippet","div.reader-post-card-summary",".portable-archive-post-description",".description"],METRICS_CONTAINER:[".pencraft.pc-display-flex.pc-gap-8.pc-reset",".post-preview-footer",".post-meta",".reader-post-card-footer",".portable-archive-post-footer",'div[class*="footer"]'],METRIC_ITEMS:'div.pencraft, a, button, span.pencraft, div[class*="meta-item"]',POTENTIAL_BUTTONS:'a, button, div[role="button"]',CONTAINER_PARENTS:[".reader-post-card",".post-preview",".portable-archive-post"],PARENT_CHECK:{TIME:"time",PROFILE:".profile-hover-card-target",CLASS_CARD:"card",CLASS_POST:"post"}}};class K{isApplicable(e){return e.includes("twitter.com")||e.includes("x.com")}scrape(e){const r=document.querySelectorAll(o.TWITTER.ARTICLE),n=[];return r.forEach(s=>{const t=this.extractTweetFromArticle(s);if(t){if(e&&e.has(t.id))return;n.push(t)}}),n}extractTweetFromArticle(e){var r,n,s,t;try{const l=e.querySelector(o.TWITTER.USER_NAME);if(!l)return null;const I=l.querySelectorAll("a"),v=((r=l.querySelector("span"))==null?void 0:r.innerText)||"Unknown",R=((s=(n=I[0])==null?void 0:n.getAttribute("href"))==null?void 0:s.replace("/","@"))||"",S=e.querySelector("time"),h=(S==null?void 0:S.getAttribute("datetime"))||new Date().toISOString(),y=(t=S==null?void 0:S.closest("a"))==null?void 0:t.getAttribute("href"),d=y?`https://twitter.com${y}`:"";if(!d)return null;const f=e.querySelector(o.TWITTER.TWEET_TEXT),A=(f==null?void 0:f.textContent)||"",m=e.querySelector(o.TWITTER.METRIC_GROUP),u=E=>{try{const _=m==null?void 0:m.querySelector(`${o.TWITTER.METRIC_TEST_ID_PREFIX}${E}"]`);if(!_)return 0;const U=_.getAttribute("aria-label")||"",N=_.querySelector(o.TWITTER.METRIC_TEXT_CONTAINER);if(N)return w(N.textContent||"");const O=U.match(/(\d+(?:,\d+)*(?:\.\d+)?[KMB万亿]?)/i);return O?w(O[0]):0}catch{return 0}},p=u("reply"),a=u("retweet"),i=u("like");let T=0;try{const E=e.querySelector(o.TWITTER.ANALYTICS_LINK);if(E){const _=E.querySelector(o.TWITTER.METRIC_TEXT_CONTAINER);if(_)T=w(_.textContent||"");else{const N=(E.textContent||"").match(/(\d+(?:,\d+)*(?:\.\d+)?[KMB万亿]?)/i);N&&(T=w(N[0]))}}}catch{T=0}return{source:"twitter",id:d,url:d,author:{name:v,handle:R},content:A,timestamp:h,metrics:{replies:p,reposts:a,likes:i,views:T||null},scrapedAt:Date.now()}}catch{return null}}}class D{isApplicable(e){return e.includes("substack.com")}scrape(e){const r=this.findArticles();console.log(`[Substack Scraper] Found ${r.length} potential articles`);const n=[];return r.forEach(s=>{const t=this.extractSubstackFromArticle(s);if(t){if(e&&e.has(t.id))return;n.push(t)}else console.log("[Substack Scraper] Failed to extract tweet from",s)}),n}findArticles(){const e=Array.from(document.querySelectorAll(o.SUBSTACK.LINK_P)),r=new Set;return e.forEach(n=>{let s=null;for(const t of o.SUBSTACK.CONTAINER_PARENTS){const l=n.closest(t);if(l){s=l;break}}if(!s){let t=n.parentElement,l=0;for(;t&&l<5;){if(t.tagName==="DIV"&&(t.querySelector(o.SUBSTACK.PARENT_CHECK.TIME)||t.querySelector(o.SUBSTACK.PARENT_CHECK.PROFILE)||t.className.includes(o.SUBSTACK.PARENT_CHECK.CLASS_CARD)||t.className.includes(o.SUBSTACK.PARENT_CHECK.CLASS_POST))){s=t;break}t=t.parentElement,l++}}s&&r.add(s)}),Array.from(r)}extractSubstackFromArticle(e){var r,n,s;try{let t=e.querySelector(o.SUBSTACK.LINK_P);t||(t=e.querySelector(o.SUBSTACK.POST_PREVIEW_TITLE)||e.querySelector(o.SUBSTACK.READER_POST_CARD_TITLE));let l=(t==null?void 0:t.getAttribute("href"))||"";if(!l)return null;l.startsWith("/")&&(l=new URL(l,window.location.href).href);let I=null;for(const u of o.SUBSTACK.AUTHOR)if(I=e.querySelector(u),I)break;const v=(((r=I==null?void 0:I.textContent)==null?void 0:r.trim())||"Unknown").slice(0,100);let R=null;for(const u of o.SUBSTACK.TIME)if(R=e.querySelector(u),R)break;let S=new Date().toISOString();if(R)if(R.tagName==="TIME")S=R.getAttribute("datetime")||S;else{const u=(n=R.textContent)==null?void 0:n.trim();u&&(S=q(u))}let h=null;for(const u of o.SUBSTACK.CONTENT)if(h=e.querySelector(u),h)break;let y=((s=h==null?void 0:h.textContent)==null?void 0:s.trim())||"";y.length>500&&(y=y.slice(0,500)+"...");let d=0,f=0,A=0,m=null;for(const u of o.SUBSTACK.METRICS_CONTAINER)if(m=e.querySelector(u),m)break;if(m&&(m.querySelectorAll(o.SUBSTACK.METRIC_ITEMS).forEach(p=>{var E;const a=(p.getAttribute("aria-label")||p.getAttribute("title")||"").toLowerCase(),i=((E=p.textContent)==null?void 0:E.trim())||"";if(!i||!/\d/.test(i))return;const T=w(i);a.includes("like")||p.querySelector('svg[class*="like"]')?d=T:a.includes("comment")||p.querySelector('svg[class*="comment"]')?f=T:(a.includes("restack")||p.querySelector('svg[class*="restack"]'))&&(A=T)}),d===0&&f===0&&A===0)){const p=Array.from(m.querySelectorAll("*")).map(i=>{var T;return(T=i.textContent)==null?void 0:T.trim()}).filter(i=>i&&/^\d+$/.test(i)&&i.length<6).map(i=>w(i||"0")),a=[...new Set(p)];a.length>=1&&(d=a[0]),a.length>=2&&(f=a[1]),a.length>=3&&(A=a[2])}return d===0&&f===0&&A===0&&e.querySelectorAll(o.SUBSTACK.POTENTIAL_BUTTONS).forEach(p=>{var E;const a=(p.getAttribute("aria-label")||p.getAttribute("title")||"").toLowerCase(),i=((E=p.textContent)==null?void 0:E.trim())||"";if(!i||!/\d/.test(i))return;const T=w(i);a.includes("like")&&d===0&&(d=T),(a.includes("comment")||a.includes("reply"))&&f===0&&(f=T),(a.includes("restack")||a.includes("share"))&&A===0&&(A=T)}),{source:"substack",id:l,url:l,author:{name:v,handle:""},content:y,timestamp:S,metrics:{replies:f,reposts:A,likes:d,views:null},scrapedAt:Date.now()}}catch{return null}}}const B=c=>c.includes("twitter.com")||c.includes("x.com")?new K:c.includes("substack.com")?new D:null;let M=!1,g=null,C=new Map;const x=3e3;let b=0;const F=3,L=B(window.location.hostname),P=()=>{if(!L){console.warn("[Scraper] No suitable scraper found for this website");return}const c=new Set(C.keys()),e=L.scrape(c),r=[];if(e.forEach(n=>{C.has(n.id)||(C.set(n.id,n),r.push(n))}),C.size>x&&Array.from(C.keys()).slice(0,C.size-x).forEach(s=>C.delete(s)),r.length>0){const n=async()=>{try{await chrome.runtime.sendMessage({type:"SCRAPED_DATA",payload:r}),b=0}catch(s){const t=(s==null?void 0:s.message)||"";if(t.includes("Extension context invalidated")){console.log("Extension context invalidated. Stopping scraper."),k();return}if(t.includes("Could not establish connection")||t.includes("Receiving end does not exist"))return;console.warn("Failed to send scraped data:",s),b++,b<F&&setTimeout(n,1e3)}};n()}},W=()=>{M||(M=!0,b=0,console.log(`[Scraper] Starting on ${window.location.hostname}`),P(),g=window.setInterval(()=>{P();const c=Math.floor(Math.random()*400)+800;window.scrollBy({top:c,behavior:"instant"})},600))},k=()=>{M=!1,g&&(clearInterval(g),g=null),console.log("[Scraper] Stopped")};chrome.runtime.onMessage.addListener(c=>{c.type==="START_SCRAPE"?W():c.type==="STOP_SCRAPE"?k():c.type==="CLEAR_DATA"?C.clear():c.type==="REQUEST_FULL_DATA"&&chrome.runtime.sendMessage({type:"SCRAPED_DATA",payload:Array.from(C.values())}).catch(console.warn)});
})()
